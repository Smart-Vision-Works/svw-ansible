- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
  ignore_errors: true

- name: Install base packages
  ansible.builtin.package:
    name:
      - whois
      - jq
      - btop
      - dirmngr
      - unzip
      - neovim
      - ncdu
      - debian-goodies
      - git
      - dnsutils
      - apt-transport-https
      - curl
      - software-properties-common
      - ubuntu-advantage-tools
      - gnupg
    state: present
  become: yes

- name: Set default editor to Neovim
  community.general.alternatives:
    name: editor
    path: /usr/bin/nvim
  become: yes

- name: Download and install Google Cloud SDK GPG key
  ansible.builtin.shell: |
    curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
    chmod 644 /usr/share/keyrings/cloud.google.gpg
  args:
    creates: /usr/share/keyrings/cloud.google.gpg
  become: yes

- name: Add Google Cloud SDK repository
  ansible.builtin.apt_repository:
    repo: 'deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main'
    state: present
    filename: google-cloud-sdk
    update_cache: yes
  become: yes
  register: gcloud_repo_result
  failed_when: false

- name: Debug Google Cloud SDK repository addition
  ansible.builtin.debug:
    var: gcloud_repo_result
  when: gcloud_repo_result.failed | default(false)

- name: Install google-cloud-cli (includes apt-transport-artifact-registry)
  ansible.builtin.package:
    name: google-cloud-cli
    state: present
  become: yes

- name: Remove old SVW repository configuration
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/svw.list
    state: absent
  become: yes
  notify: Update apt cache

- name: Remove old SVW GPG keys
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  become: yes
  loop:
    - /usr/share/keyrings/svw.gpg
    - /usr/share/keyrings/svw.asc
  notify: Update apt cache

- name: Add SVW Artifact Registry repository
  ansible.builtin.apt_repository:
    repo: 'deb ar+https://us-west1-apt.pkg.dev/projects/svw-proper apt-repo main'
    state: present
    filename: svw-artifact-registry
    update_cache: yes
  become: yes
  register: artifact_repo_result
  failed_when: false

- name: Debug Artifact Registry repository addition
  ansible.builtin.debug:
    var: artifact_repo_result
  when: artifact_repo_result.failed | default(false)

- name: Install Landscape client
  ansible.builtin.package:
    name: landscape-client
    state: latest
  become: yes

- name: Configure Landscape client
  ansible.builtin.template:
    src: 'ls-client.conf.j2'
    dest: '/etc/landscape/client.conf'
    owner: 'landscape'
    mode: '0600'
  become: yes
  # notify: Restart Landscape client

- name: Add landcape-client configuration file
  ansible.builtin.copy:
    dest: '/etc/default/landscape-client'
    src: 'landscape-client'
    owner: 'root'
    group: 'root'
    mode: '0644'
  become: yes
  register: landscape_client_config_result

# - name: Get Landscape service running
#   ansible.builtin.systemd:
#     name: landscape-client
#     state: started
#     enabled: true

- name: Install sentinel agent
  ansible.builtin.package:
    name: sentinelagent
    state: present
    update_cache: yes
    force: yes
  become: yes
  register: sentinelagent_result

- name: Add SentinelOne management token
  ansible.builtin.command: >
    /opt/sentinelone/bin/sentinelctl management token set {{ sentinel_token }}
  args:
    warn: false
  become: yes
  register: sentinel_token_result
  when:
    - sentinel_token is defined
    - sentinelagent_result.changed

- name: Add LetsEncrypt CAs
  ansible.builtin.copy:
    src: "letsencrypt/{{ item }}.crt"
    dest: "/etc/ssl/certs/letsencrypt-{{ item }}.crt"
    owner: root
    group: root
    mode: '0644'
  become: yes
  loop:
    - e5
    - e6
    - isrgrootx1
    - isrg-root-x2-cross-signed
    - isrg-root-x2
    - r10
    - r11
  notify: Update CA certificates

- name: Pro Attach
  ansible.builtin.command: >
    /usr/bin/pro attach {{ ubuntu_pro_key }}
  args:
    warn: false
  become: yes
  when:
    - ubuntu_pro_key is defined
    - landscape_client_config_result.changed
  register: pro_attach_result
  changed_when: pro_attach_result.rc == 0
