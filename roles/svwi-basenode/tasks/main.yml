- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
  ignore_errors: true

- name: Install base packages
  ansible.builtin.package:
    name:
      - whois
      - jq
      - btop
      - dirmngr
      - unzip
      - neovim
      - ncdu
      - debian-goodies
      - git
      - dnsutils
      - apt-transport-https
      - curl
      - software-properties-common
      - ubuntu-advantage-tools
    state: present
  become: yes

- name: Set default editor to Neovim
  community.general.alternatives:
    name: editor
    path: /usr/bin/nvim
  become: yes

- name: Get SVW package repo key
  ansible.builtin.get_url:
    url: 'https://repo.smartvisionworks.com/svw.asc'
    dest: '/usr/share/keyrings/svw.asc'
    mode: '0644'
    force: yes
  become: yes
  register: svw_key_result

- name: Remove old SVW package repo key if asc changed
  ansible.builtin.file:
    path: /usr/share/keyrings/svw.gpg
    state: absent
  become: yes
  when: svw_key_result.changed

- name: Add SVW package repo key
  ansible.builtin.command:
    cmd: >
      gpg
        --batch
        --no-default-keyring
        --dearmor
        -o /usr/share/keyrings/svw.gpg
        /usr/share/keyrings/svw.asc
    creates: '/usr/share/keyrings/svw.gpg'
  become: yes

- name: Install SVW package repo
  ansible.builtin.apt_repository:
    repo: 'deb [arch=amd64 signed-by=/usr/share/keyrings/svw.gpg] https://repo.smartvisionworks.com/jammy  jammy main'
    state: present
    filename: svw
    update_cache: yes
  become: yes

- name: Install Landscape client
  ansible.builtin.package:
    name: landscape-client
    state: latest
  become: yes

- name: Configure Landscape client
  ansible.builtin.template:
    src: 'ls-client.conf.j2'
    dest: '/etc/landscape/client.conf'
    owner: 'landscape'
    mode: '0600'
  become: yes
  # notify: Restart Landscape client

- name: Add landcape-client configuration file
  ansible.builtin.copy:
    dest: '/etc/default/landscape-client'
    src: 'landscape-client'
    owner: 'root'
    group: 'root'
    mode: '0644'
  become: yes
  register: landscape_client_config_result

# - name: Get Landscape service running
#   ansible.builtin.systemd:
#     name: landscape-client
#     state: started
#     enabled: true

- name: Install sentinel agent
  ansible.builtin.package:
    name: sentinelagent
    state: present
    update_cache: yes
    force: yes
  become: yes
  register: sentinelagent_result

# - name: Install SVW package repo
#   ansible.builtin.apt_repository:
#     repo: 'deb [arch=amd64 signed-by=/usr/share/keyrings/svw.gpg] https://repo.smartvisionworks.com/jammy jammy main'
#     state: present
#     filename: svw
#     update_cache: yes
# this was to replace builtin.file, but it didn't do what we needed. so we added a handler. 

- name: Add SVW repo file
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/svw.list
    content: |
      deb [arch=amd64 signed-by=/usr/share/keyrings/svw.gpg] https://repo.smartvisionworks.com/jammy jammy main
    owner: root
    group: root
    mode: '0644'
  become: yes
  notify: Update apt cache

- name: Add SentinelOne management token
  ansible.builtin.command: >
    /opt/sentinelone/bin/sentinelctl management token set {{ sentinel_token }}
  args:
    warn: false
  become: yes
  register: sentinel_token_result
  when:
    - sentinel_token is defined
    - sentinelagent_result.changed

- name: Add LetsEncrypt CAs
  ansible.builtin.copy:
    src: "letsencrypt/{{ item }}.crt"
    dest: "/etc/ssl/certs/letsencrypt-{{ item }}.crt"
    owner: root
    group: root
    mode: '0644'
  become: yes
  loop:
    - e5
    - e6
    - isrgrootx1
    - isrg-root-x2-cross-signed
    - isrg-root-x2
    - r10
    - r11
  notify: Update CA certificates

- name: Pro Attach
  ansible.builtin.command: >
    /usr/bin/pro attach {{ ubuntu_pro_key }}
  args:
    warn: false
  become: yes
  when:
    - ubuntu_pro_key is defined
    - landscape_client_config_result.changed
  register: pro_attach_result
  changed_when: pro_attach_result.rc == 0