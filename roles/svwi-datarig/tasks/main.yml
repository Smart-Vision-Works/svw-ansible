---
# tasks file for svwi-datarig

# Include base roles
- name: Include svwi-basenode role
  ansible.builtin.include_role:
    name: svwi-basenode

- name: Include svwi-users admins
  ansible.builtin.include_role:
    name: svwi-users
    tasks_from: admins

- name: Include svwi-users data
  ansible.builtin.include_role:
    name: svwi-users
    tasks_from: data

- name: Include svwi-users service
  ansible.builtin.include_role:
    name: svwi-users
    tasks_from: service

# Remove old modprobe configs
- name: Remove old modprobe bridge.conf
  ansible.builtin.file:
    path: /etc/modprobe.d/bridge.conf
    state: absent
  tags:
    - kernel

- name: Remove old modprobe br_netfilter.conf
  ansible.builtin.file:
    path: /etc/modprobe.d/br_netfilter.conf
    state: absent
  tags:
    - kernel

# Load kernel modules
- name: Load kernel modules
  community.general.modprobe:
    name: "{{ item }}"
    state: present
  loop: "{{ kernel_modules }}"
  tags:
    - kernel

# Docker installation
- name: Install Docker using community.docker.docker role
  ansible.builtin.include_role:
    name: geerlingguy.docker
  vars:
    docker_install_compose: false
  tags:
    - docker

# Docker cron job for cleanup
- name: Create docker system prune cron job
  ansible.builtin.cron:
    name: docker-system-prune
    minute: "17"
    hour: "22"
    user: root
    job: "docker system prune -f"
    state: present
  tags:
    - cron

# Package management
- name: Install required packages
  ansible.builtin.apt:
    name: "{{ packages_to_install }}"
    state: present
    update_cache: yes
  tags:
    - packages

# Remove unwanted packages
- name: Remove unwanted packages
  ansible.builtin.apt:
    name: "{{ packages_to_remove }}"
    state: absent
    purge: yes
  tags:
    - packages

# Stop and disable removed services
- name: Stop and disable nomad service
  ansible.builtin.systemd:
    name: nomad
    state: stopped
    enabled: false
  failed_when: false
  tags:
    - services

- name: Stop and disable consul service
  ansible.builtin.systemd:
    name: consul
    state: stopped
    enabled: false
  failed_when: false
  tags:
    - services

- name: Stop and disable zabbix-agent2 service
  ansible.builtin.systemd:
    name: zabbix-agent2
    state: stopped
    enabled: false
  failed_when: false
  tags:
    - services

- name: Stop and disable zabbix-agent service
  ansible.builtin.systemd:
    name: zabbix-agent
    state: stopped
    enabled: false
  failed_when: false
  tags:
    - services

# User management
- name: Ensure svw user exists and is in docker group
  ansible.builtin.user:
    name: svw
    shell: /bin/bash
    create_home: yes
    groups: docker
    append: yes
  tags:
    - users

# NFS configuration
- name: Create NFS mount directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /auto
    - /auto/shared
    - /auto/ds
    - /auto/tmp
  tags:
    - nfs

- name: Mount NFS share
  ansible.posix.mount:
    path: "{{ nfs_mount_point }}"
    src: "{{ nfs_server }}:{{ nfs_share }}"
    fstype: nfs
    opts: "{{ nfs_mount_opts }}"
    state: mounted
  tags:
    - nfs

- name: Mount new NAS shares
  ansible.posix.mount:
    path: "{{ item.mount_point }}"
    src: "{{ new_nas_server }}:{{ item.share }}"
    fstype: nfs
    opts: "{{ nfs_mount_opts }}"
    state: mounted
  loop: "{{ new_nas_mounts }}"
  tags:
    - nfs

# Sysctl configuration
- name: Set vm.swappiness
  ansible.posix.sysctl:
    name: vm.swappiness
    value: "{{ vm_swappiness }}"
    state: present
    reload: yes
  tags:
    - sysctl

# NVIDIA Container Toolkit setup
- name: Download NVIDIA container toolkit GPG key
  ansible.builtin.get_url:
    url: https://nvidia.github.io/libnvidia-container/gpgkey
    dest: /tmp/nvidia-container-toolkit-keyring.asc
    mode: '0644'
  tags:
    - nvidia

- name: Dearmor NVIDIA GPG key
  ansible.builtin.shell: |
    gpg --dearmor < /tmp/nvidia-container-toolkit-keyring.asc > /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
  args:
    creates: /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
  tags:
    - nvidia

- name: Add NVIDIA container toolkit repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg arch=amd64] https://nvidia.github.io/libnvidia-container/stable/deb/amd64 /"
    state: present
    filename: nvidia-container-toolkit
  tags:
    - nvidia

# Google Cloud SDK setup
- name: Download Google Cloud SDK GPG key
  ansible.builtin.get_url:
    url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
    dest: /tmp/cloud.google.gpg
    mode: '0644'
  tags:
    - gcloud

- name: Add Google Cloud SDK GPG key to keyring
  ansible.builtin.shell: |
    apt-key --keyring /usr/share/keyrings/cloud.google.gpg add /tmp/cloud.google.gpg
  args:
    creates: /usr/share/keyrings/cloud.google.gpg
  tags:
    - gcloud

- name: Add Google Cloud SDK repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/cloud.google.gpg arch=amd64] https://packages.cloud.google.com/apt cloud-sdk main"
    state: present
    filename: google-cloud-sdk
  tags:
    - gcloud

# Docker daemon configuration
- name: Configure Docker daemon.json
  ansible.builtin.copy:
    src: docker-daemon.json
    dest: /etc/docker/daemon.json
    owner: root
    group: root
    mode: '0644'
  notify: Restart Docker
  tags:
    - docker

# nuctl installation
- name: Download nuctl binary
  ansible.builtin.get_url:
    url: "https://github.com/nuclio/nuclio/releases/download/{{ nuctl_version }}/nuctl-{{ nuctl_version }}-linux-amd64"
    dest: "/opt/nuctl-{{ nuctl_version }}-linux-amd64"
    mode: '0755'
  tags:
    - nuctl

- name: Create nuctl symlink
  ansible.builtin.file:
    src: "/opt/nuctl-{{ nuctl_version}}-linux-amd64"
    dest: /usr/local/bin/nuctl
    state: link
  tags:
    - nuctl

# SSH/Boundary configuration
- name: Copy Boundary CA public key
  ansible.builtin.copy:
    src: boundary-ca.pub
    dest: /etc/ssh/boundary-ca.pub
    owner: svw
    group: svw
    mode: '0644'
  tags:
    - ssh

- name: Copy Boundary SSH configuration
  ansible.builtin.copy:
    src: boundary.conf
    dest: /etc/ssh/sshd_config.d/boundary.conf
    owner: root
    group: root
    mode: '0644'
  notify: Restart SSH
  tags:
    - ssh

- name: Ensure SSH service is running and enabled
  ansible.builtin.systemd:
    name: ssh
    state: started
    enabled: yes
  tags:
    - ssh

# Security updates cron job (set to absent as in Puppet)
- name: Copy security updates script
  ansible.builtin.copy:
    src: data-install-security-updates.sh
    dest: /opt/data-install-security-updates.sh
    owner: root
    group: root
    mode: '0744'
  tags:
    - scripts

- name: Remove old security updates cron job
  ansible.builtin.cron:
    name: data-install-security-updates
    state: absent
  tags:
    - cron
